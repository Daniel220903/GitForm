@model IEnumerable<FormClick.Models.User>

@if (TempData["Mensaje"] != null){
    <p style="color: red">@TempData["Mensaje"]</p>
}

<h1>Lista de Usuarios</h1>
<form id="user-actions-form" method="post" asp-controller="Usuario" asp-action="AccionUsuario">
    <input type="hidden" name="selectedUserIds" id="selected-user-ids">
    <input type="hidden" name="actionType" id="action-type">

    <div style="margin-bottom: 15px;">
        <button type="button" id="btn-delete" class="btn btn-danger" disabled>
            <i class="fas fa-trash-alt"></i> Delete
        </button>
        <button type="button" id="btn-ban" class="btn btn-warning" disabled>
            <i class="fas fa-lock"></i> Ban
        </button>
        <button type="button" id="btn-unban" class="btn btn-success" disabled>
            <i class="fas fa-unlock"></i> Unban
        </button>
        <button type="button" id="btn-add-admin" class="btn btn-primary" disabled>
            <i class="fas fa-user-plus"></i> Add Admin
        </button>
        <button type="button" id="btn-delete-admin" class="btn btn-danger" disabled>
            <i class="fas fa-trash-alt"></i> Delete Admin
        </button>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>Name</th>
                <th>Email</th>
                <th>Cellphone</th>
                <th>Registration Date</th>
                <th>Last Active</th>
                <th>Status</th>
                <th>Administrador</th>
                <th>Verified</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Model){
                <tr>
                    <td><input type="checkbox" class="user-checkbox" data-user-id="@user.Id"></td>
                    <td>@user.Name</td>
                    <td>@user.Email</td>
                    <td>@user.Cellphone</td>
                    <td>@user.CreatedAt</td>
                    <td>@user.LastLogin?.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>
                        @if (user.Banned == true) {
                            <h2>Baneado</h2>
                        } else {
                            <h2>FAIN</h2>
                        }
                    </td>
                    <td>
                        @if (user.Admin == true){
                            <h2>Administrador</h2>
                        } else{
                            <h2>No administrador</h2>
                        }
                    </td>
                    <td>
                        @if (user.Verified == true){
                            <h2>Verificado</h2>
                        } else {
                            <h2>No verificado</h2>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</form>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const selectAllCheckbox = document.getElementById('select-all');
        const userCheckboxes = document.querySelectorAll('.user-checkbox');
        const btnBorrar = document.getElementById('btn-delete');
        const btnBloquear = document.getElementById('btn-ban');
        const btnDesbloquear = document.getElementById('btn-unban');
        const btnAddAdmin = document.getElementById('btn-add-admin');
        const btnDeleteAdmin = document.getElementById('btn-delete-admin');
        const form = document.getElementById('user-actions-form');
        const selectedUserIdsInput = document.getElementById('selected-user-ids');
        const actionTypeInput = document.getElementById('action-type');

        function updateButtons() {
            const anyChecked = Array.from(userCheckboxes).some(cb => cb.checked);
            btnBorrar.disabled = !anyChecked;
            btnBloquear.disabled = !anyChecked
            btnDesbloquear.disabled = !anyChecked;
            btnAddAdmin.disabled = !anyChecked;
            btnDeleteAdmin.disabled = !anyChecked;
        }

        selectAllCheckbox.addEventListener('change', function () {
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateButtons();
        });

        userCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateButtons);
        });

        function submitForm(actionType) {
            const selectedUsers = Array.from(userCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.getAttribute('data-user-id'));

            const payload = {
                actionType: actionType,
                selectedUsers: selectedUsers
            };

            fetch('/Admin/AdminAction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => {
                if (response.ok) {
                    window.location.href = '/Admin/Index';
                } else {
                    console.error('Error en la solicitud:', response.statusText);
                }
            })
            .catch(error => console.error('Error de red:', error));
        }

        btnBorrar.addEventListener('click', () => submitForm('borrar'));
        btnBloquear.addEventListener('click', () => submitForm('bloquear'));
        btnDesbloquear.addEventListener('click', () => submitForm('desbloquear'));
        btnAddAdmin.addEventListener('click', () => submitForm('addAdmin'));
        btnDeleteAdmin.addEventListener('click', () => submitForm('deleteAdmin'));
    });
</script>

